from .outlier_ids import *

import numpy as np

from connectome import Chain, CacheToRam, Apply, Filter

from lowres.dataset.luna import LUNA, CacheToDisk
from lowres.dataset.luna.transforms import DropTracheaMask, ProcessLungsMask, CropToLungsMask, ApplyLungsMask, \
    MakeCentersNComponents, normalize_intensities


methods = ('image', 'lung_nodules_mask', 'lung_nodules_centers')

preprocessing = [
    Filter.drop(outlier_ids),
    DropTracheaMask(),
    ProcessLungsMask(),
    CropToLungsMask(),
    ApplyLungsMask(),
    MakeCentersNComponents(),
    Apply(image=normalize_intensities),
    Apply(image=np.float16, lung_nodules_mask=np.float16),
    CacheToDisk(methods),
    CacheToRam(methods),
]

dataset = Chain(
    LUNA(),
    *preprocessing,
)

loader = dataset._compile(methods)
